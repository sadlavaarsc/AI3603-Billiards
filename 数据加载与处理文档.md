# 台球AI项目 - 训练数据加载与处理文档

## 1. 数据处理概述

本项目使用双网络架构（行为网络+价值网络）来训练台球AI模型。训练数据的加载和预处理由`data_loader.py`模块负责，该模块提供了完整的数据加载、预处理和批处理功能。

## 2. 数据需求与格式

### 2.1 输入数据要求

模型输入需要包含连续三局的状态向量，具体要求如下：

#### 状态向量格式
- **维度**：每局状态为81维向量
- **数据结构**：连续3局的状态组合成 [3, 81] 形状的数组
- **状态向量组成**：
  - 0-63维：16个球的特征（每个球4个特征）
    - x坐标
    - y坐标
    - z坐标
    - 进袋标志（0或1）
  - 64-65维：球桌尺寸（宽度和长度，2.540m×1.270m，常量）
  - 66-80维：目标球特征（二进制值）

#### 标签数据要求
- **行为标签**：5维动作向量 [V0, phi, theta, a, b]
  - V0：击球速度
  - phi：水平角度
  - theta：垂直角度
  - a：x方向偏移
  - b：y方向偏移
- **价值标签**：1维胜率（0-1范围）

### 2.2 数据文件格式

训练数据应以JSON格式存储，具体格式如下：

```json
[
  {
    "states": [[局1状态向量], [局2状态向量], [局3状态向量]],  // 3×81的嵌套列表
    "action": [v0, phi, theta, a, b],  // 5维动作向量
    "value": 0.8,  // 胜率（0-1）
    "history_length": 3  // 历史局数标记
  }
  // 更多样本...
]
```

## 3. 数据加载与预处理流程

数据加载和预处理流程由以下几个核心组件组成：

### 3.1 StatePreprocessor - 状态预处理器

`StatePreprocessor`类负责对状态向量进行归一化处理，确保网络训练的稳定性：

#### 核心功能：
- **球坐标归一化**：
  - x坐标归一化到0-1范围（相对于球桌宽度）
  - y坐标归一化到0-1范围（相对于球桌长度）
  - z坐标归一化到-1到1范围（相对于球直径）
- **进袋标志**：保持不变（0或1）
- **球桌尺寸归一化**：归一化到标准尺寸的相对比例
- **目标球特征**：保持不变（二进制值）

#### 使用示例：
```python
from data_loader import StatePreprocessor

# 创建预处理器
preprocessor = StatePreprocessor(table_width=2.845, table_length=1.4225)

# 处理状态向量
processed_states = preprocessor(three_game_states)  # three_game_states形状为[3, 81]
```

### 3.2 数据集合并与创建

`create_combined_dataset`函数负责合并行为数据和价值数据：

#### 核心功能：
- 加载行为数据目录中的所有JSON文件
- 加载价值数据目录中的所有JSON文件
- 创建状态向量到价值标签的映射
- 将价值标签与对应的行为数据合并
- 保存合并后的数据集到JSON文件

#### 使用示例：
```python
from data_loader import create_combined_dataset

# 合并数据集
combined_data = create_combined_dataset(
    behavior_data_dir='path/to/behavior/data',
    value_data_dir='path/to/value/data'
)
```

### 3.3 数据加载器创建

`create_dataloader`函数负责创建用于训练的PyTorch DataLoader：

#### 核心功能：
- 创建自定义Dataset类处理数据
- 应用预处理器进行状态归一化
- 配置批处理、随机打乱等参数
- 启用多线程加载和内存固定优化（在CUDA环境下）

#### 使用示例：
```python
from data_loader import create_dataloader

# 创建数据加载器
dataloader = create_dataloader(
    data=combined_data,  # 合并后的数据列表
    batch_size=32,  # 批次大小
    shuffle=True,  # 是否打乱数据
    preprocessor=preprocessor  # 状态预处理器
)
```

## 4. 数据生成与测试

项目提供了`generate_sample_data`函数用于生成测试数据：

#### 核心功能：
- 创建行为数据目录和价值数据目录
- 生成指定数量的样本数据
- 模拟球桌尺寸和状态向量
- 生成动作向量和胜负标签
- 保存生成的数据到JSON文件

#### 使用示例：
```python
from data_loader import generate_sample_data

# 生成样本数据
generate_sample_data(
    output_dir='sample_data',  # 输出目录
    num_samples=100  # 样本数量
)
```

## 5. 训练流程中的数据使用

在`train_dual_network.py`中，数据处理和模型训练的完整流程如下：

1. **生成或加载数据**：使用`generate_sample_data`生成测试数据或加载实际数据
2. **创建预处理器**：初始化`StatePreprocessor`进行状态归一化
3. **合并数据集**：使用`create_combined_dataset`合并行为和价值数据
4. **创建数据加载器**：使用`create_dataloader`配置批处理参数
5. **训练模型**：`DualNetworkTrainer`使用数据加载器训练模型

#### 完整流程示例：
```python
# 生成样本数据
generate_sample_data('sample_data', num_samples=100)

# 创建预处理器
preprocessor = StatePreprocessor()

# 合并数据集
combined_data = create_combined_dataset(
    'sample_data/behavior',
    'sample_data/value'
)

# 创建数据加载器
train_loader = create_dataloader(
    combined_data,
    batch_size=32,
    shuffle=True,
    preprocessor=preprocessor
)

# 训练模型
trainer = DualNetworkTrainer()
trainer.train(train_loader, epochs=5, save_path='models/dual_network.pt')
```

## 6. 数据处理最佳实践

### 6.1 数据质量保证
- 确保状态向量维度正确（3×81）
- 验证球坐标在合理范围内
- 确保动作向量和价值标签有效

### 6.2 性能优化
- 在CUDA环境下启用`pin_memory`提升性能
- 根据硬件配置调整`num_workers`参数
- 使用适当的批次大小平衡训练效率和内存使用

### 6.3 数据增强
- 考虑添加球桌尺寸变化的数据增强
- 可以添加球位置的小幅随机扰动

## 7. 代码结构说明

数据加载和预处理相关的主要组件：

| 组件 | 功能 | 文件位置 |
|------|------|----------|
| StatePreprocessor | 状态向量归一化处理 | data_loader.py |
| create_combined_dataset | 合并行为和价值数据 | data_loader.py |
| create_dataloader | 创建PyTorch DataLoader | data_loader.py |
| generate_sample_data | 生成测试数据 | data_loader.py |
| BilliardsDataset | 基础数据集类（用于直接加载目录中的数据） | data_loader.py |

## 8. 输入输出示例

### 8.1 输入示例：原始数据样本

```json
{
  "states": [
    [0.5, 0.3, 0.0, 0, 1.2, 0.8, 0.0, 0, ...],  // 第一局状态（81维）
    [0.45, 0.35, 0.0, 0, 1.1, 0.85, 0.0, 0, ...],  // 第二局状态（81维）
    [0.4, 0.4, 0.0, 0, 1.0, 0.9, 0.0, 0, ...]  // 第三局状态（81维）
  ],
  "action": [2.5, 45.0, 15.0, 0.1, -0.2],
  "value": 0.7,
  "history_length": 3
}
```

### 8.2 输出示例：处理后的数据批次

```python
# 数据加载器返回的批次示例
# states形状: [32, 3, 81]  # 32个样本，每个样本包含3局，每局81维状态
# policy_targets形状: [32, 5]  # 32个样本，每个样本5维动作
# value_targets形状: [32, 1]  # 32个样本，每个样本1维胜率

for states, policy_targets, value_targets in dataloader:
    print(f"批次包含 {states.size(0)} 个样本")
    print(f"状态形状: {states.shape}")
    print(f"动作标签形状: {policy_targets.shape}")
    print(f"价值标签形状: {value_targets.shape}")
    # 输出：
    # 批次包含 32 个样本
    # 状态形状: torch.Size([32, 3, 81])
    # 动作标签形状: torch.Size([32, 5])
    # 价值标签形状: torch.Size([32, 1])
    break
```
